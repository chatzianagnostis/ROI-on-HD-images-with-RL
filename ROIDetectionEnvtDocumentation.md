# ROIDetectionEnv: Περιβάλλον Ανίχνευσης Περιοχών Ενδιαφέροντος

## Επισκόπηση

Το `ROIDetectionEnv` είναι ένα προσαρμοσμένο περιβάλλον ενισχυτικής μάθησης (Reinforcement Learning) που έχει σχεδιαστεί για την εκπαίδευση πρακτόρων στην αποτελεσματική ανίχνευση και τοποθέτηση περιοχών ενδιαφέροντος (Regions of Interest - ROIs) σε εικόνες. Το περιβάλλον υλοποιεί τη διεπαφή OpenAI Gym (`gym.Env`) και χρησιμοποιεί το μοντέλο YOLO για την αξιολόγηση των επιδόσεων ανίχνευσης.

## Λειτουργία

Ο πράκτορας καλείται να τοποθετήσει στρατηγικά ορθογώνια πλαίσια (bounding boxes) σε μια εικόνα με στόχο να βελτιώσει την ακρίβεια ανίχνευσης αντικειμένων σε σύγκριση με την εκτέλεση ανίχνευσης στο σύνολο της εικόνας. Το περιβάλλον ανταμείβει τον πράκτορα όταν οι επιλεγμένες περιοχές ενδιαφέροντος επιτυγχάνουν καλύτερη απόδοση ανίχνευσης με την ελάχιστη δυνατή κάλυψη της εικόνας.

## Αρχικοποίηση

```python
def __init__(self, dataset, bbox_size=(32, 32), yolo_model_path='yolov8n.pt'):
    """
    Αρχικοποίηση του Περιβάλλοντος Ανίχνευσης Περιοχών Ενδιαφέροντος.
    
    Παράμετροι:
        dataset: Αντικείμενο ROIDataset για τη φόρτωση εικόνων και σχολιασμών
        bbox_size: Μέγεθος των bounding boxes προς τοποθέτηση (πλάτος, ύψος)
        yolo_model_path: Διαδρομή προς το μοντέλο YOLO
    """
```

### Παράμετροι

* **dataset**: Αντικείμενο τύπου ROIDataset που παρέχει εικόνες και σχολιασμούς (annotations) για το περιβάλλον.
* **bbox_size**: Το προεπιλεγμένο μέγεθος των bounding boxes (πλάτος, ύψος) σε pixels.
* **yolo_model_path**: Η διαδρομή προς το προεκπαιδευμένο μοντέλο YOLO.

### Ιδιότητες

* **dataset**: Το dataset από το οποίο φορτώνονται οι εικόνες και οι σχολιασμοί.
* **image_size**: Οι διαστάσεις των εικόνων στο dataset.
* **bbox_size**: Το μέγεθος των bounding boxes.
* **current_sample**: Το τρέχον δείγμα από το dataset.
* **bboxes**: Λίστα με τα τοποθετημένα bounding boxes.
* **detector**: Το φορτωμένο μοντέλο YOLO για ανίχνευση αντικειμένων.
* **current_bbox**: Το τρέχον bounding box που μπορεί να μετακινηθεί.
* **full_image_results**: Τα αποτελέσματα ανίχνευσης του YOLO στο σύνολο της εικόνας.

## Χώρος Ενεργειών (Action Space)

Ο χώρος ενεργειών είναι διακριτός (`spaces.Discrete(7)`) και περιλαμβάνει τις ακόλουθες ενέργειες:

* **0**: Μετακίνηση του bounding box προς τα πάνω
* **1**: Μετακίνηση του bounding box προς τα κάτω
* **2**: Μετακίνηση του bounding box προς τα αριστερά
* **3**: Μετακίνηση του bounding box προς τα δεξιά
* **4**: Τοποθέτηση του bounding box στην τρέχουσα θέση
* **5**: Αφαίρεση του τελευταίου τοποθετημένου bounding box
* **6**: Τερματισμός του επεισοδίου

## Χώρος Παρατηρήσεων (Observation Space)

Ο χώρος παρατηρήσεων είναι ένα λεξικό (`spaces.Dict`) με δύο κλειδιά:

* **image**: Η τρέχουσα εικόνα με τα οπτικά σημαδεμένα bounding boxes.
* **bbox_state**: Ένας πίνακας (100, 4) με τις κανονικοποιημένες θέσεις και διαστάσεις των τοποθετημένων bounding boxes.

## Βασικές Μέθοδοι

### reset()

```python
def reset(self):
    """Επαναφορά του περιβάλλοντος με νέα εικόνα"""
```

Αυτή η μέθοδος:
1. Φορτώνει μια νέα εικόνα από το dataset.
2. Εκτελεί ανίχνευση YOLO στο σύνολο της εικόνας για να αποκτήσει τα βασικά αποτελέσματα.
3. Επαναφέρει τη λίστα των bounding boxes.
4. Τοποθετεί το τρέχον bounding box στο κέντρο της εικόνας.
5. Επιστρέφει την αρχική παρατήρηση.

### step(action)

```python
def step(self, action):
    """Εκτέλεση ενέργειας στο περιβάλλον βάσει της επιλεγμένης ενέργειας"""
```

Αυτή η μέθοδος:
1. Εκτελεί την αντίστοιχη ενέργεια με βάση την τιμή της παραμέτρου `action`.
2. Υπολογίζει την ανταμοιβή για την ενέργεια.
3. Ενημερώνει την κατάσταση του περιβάλλοντος.
4. Επιστρέφει την νέα παρατήρηση, την ανταμοιβή, ένα flag για το αν το επεισόδιο έχει τελειώσει, και πρόσθετες πληροφορίες.

### _get_observation()

```python
def _get_observation(self):
    """Λήψη της τρέχουσας παρατήρησης"""
```

Αυτή η μέθοδος:
1. Παράγει ένα αντίγραφο της τρέχουσας εικόνας.
2. Σχεδιάζει όλα τα τοποθετημένα bounding boxes με πράσινο χρώμα.
3. Σχεδιάζει το τρέχον κινούμενο bounding box με μπλε χρώμα.
4. Δημιουργεί έναν πίνακα με τις κανονικοποιημένες θέσεις και διαστάσεις των bounding boxes.
5. Επιστρέφει ένα λεξικό με την εικόνα και την κατάσταση των bounding boxes.

## Μέθοδοι Διαχείρισης Bounding Boxes

### _move_bbox(direction)

```python
def _move_bbox(self, direction):
    """Μετακίνηση του τρέχοντος bounding box"""
```

Μετακινεί το τρέχον bounding box κατά ένα βήμα (προεπιλογή: 8 pixels) προς την κατεύθυνση που καθορίζεται από την παράμετρο `direction`. Η μέθοδος διασφαλίζει ότι το bounding box παραμένει εντός των ορίων της εικόνας.

### _place_bbox()

```python
def _place_bbox(self):
    """Τοποθέτηση του τρέχοντος bounding box"""
```

Τοποθετεί το τρέχον bounding box στη λίστα των τοποθετημένων bounding boxes. Εάν υπάρχει σημαντική επικάλυψη (IoU > 0.3) με κάποιο υπάρχον bounding box, επιστρέφει ποινή -1. Διαφορετικά, επιστρέφει 0.

### _remove_bbox()

```python
def _remove_bbox(self):
    """Αφαίρεση του τελευταίου τοποθετημένου bounding box"""
```

Αφαιρεί το τελευταίο bounding box από τη λίστα. Εάν η λίστα είναι κενή, επιστρέφει ποινή -0.1. Διαφορετικά, επιστρέφει 0.

## Μέθοδοι Αξιολόγησης

### _calculate_iou(box1, box2)

```python
def _calculate_iou(self, box1, box2):
    """Υπολογισμός του IoU (Intersection over Union) μεταξύ δύο bounding boxes"""
```

Υπολογίζει το IoU (Intersection over Union) μεταξύ δύο bounding boxes. Αυτή η μέθοδος χρησιμοποιείται για να ελέγξει την επικάλυψη μεταξύ των bounding boxes κατά την τοποθέτηση.

### _scale_bbox_to_original(bbox)

```python
def _scale_bbox_to_original(self, bbox):
    """Κλιμάκωση ενός bbox από τη μεγέθους της εικόνας πίσω στις αρχικές διαστάσεις"""
```

Κλιμακώνει ένα bounding box από τις διαστάσεις της επεξεργασμένης εικόνας πίσω στις αρχικές διαστάσεις της εικόνας, χρησιμοποιώντας τους συντελεστές κλιμάκωσης που παρέχονται από το dataset.

### _evaluate_roi()

```python
def _evaluate_roi(self):
    """Αξιολόγηση των ROIs συγκρίνοντας την ανίχνευση YOLO σε ROIs έναντι της πλήρους εικόνας"""
```

Αξιολογεί την απόδοση των τοποθετημένων περιοχών ενδιαφέροντος συγκρίνοντας τα αποτελέσματα ανίχνευσης YOLO στις ROIs με τα αποτελέσματα στο σύνολο της εικόνας. Επιστρέφει τις μετρήσεις για αμφότερα και μια αξιολόγηση της απόδοσης.

### _get_detection_metrics(results)

```python
def _get_detection_metrics(self, results):
    """Εξαγωγή μετρήσεων precision, recall, mAP50 από τα αποτελέσματα YOLO"""
```

Εξάγει μετρήσεις όπως precision, recall και mAP50 από τα αποτελέσματα ανίχνευσης YOLO. Η μέθοδος αυτή προσαρμόζεται στις διαφορετικές εκδόσεις του YOLO και παρέχει εναλλακτικούς τρόπους υπολογισμού των μετρήσεων.

### _calculate_final_reward()

```python
def _calculate_final_reward(self):
    """Υπολογισμός της τελικής ανταμοιβής με βάση τη διαφορά μεταξύ της ακρίβειας ROI και της ακρίβειας της πλήρους εικόνας"""
```

Υπολογίζει την τελική ανταμοιβή με βάση:
1. Τη διαφορά μεταξύ των μετρήσεων των ROIs και των μετρήσεων της πλήρους εικόνας.
2. Το ποσοστό κάλυψης της εικόνας από τις ROIs.
3. Την αποτελεσματικότητα των ROIs (επίδοση σε σχέση με την κάλυψη).
4. Ποινή για υπερβολικό αριθμό ROIs.

## Μέθοδος Απεικόνισης

### render(mode='rgb_array')

```python
def render(self, mode='rgb_array'):
    """Απεικόνιση της τρέχουσας κατάστασης του περιβάλλοντος"""
```

Απεικονίζει την τρέχουσα κατάσταση του περιβάλλοντος. Περιλαμβάνει:
1. Την τρέχουσα εικόνα.
2. Τα ground truth bounding boxes (αν υπάρχουν) με κίτρινο χρώμα.
3. Τα τοποθετημένα bounding boxes με πράσινο χρώμα.
4. Το τρέχον κινούμενο bounding box με μπλε χρώμα.

Η μέθοδος υποστηρίζει δύο λειτουργίες:
* **rgb_array**: Επιστρέφει την εικόνα ως πίνακα numpy.
* **human**: Προβάλλει την εικόνα σε ένα παράθυρο χρησιμοποιώντας την OpenCV.

## Διαδικασία Λειτουργίας

Η τυπική ροή λειτουργίας του περιβάλλοντος είναι η εξής:

1. **Αρχικοποίηση**:
   ```python
   env = ROIDetectionEnv(dataset=my_dataset, bbox_size=(64, 64))
   ```

2. **Επαναφορά του περιβάλλοντος και λήψη της αρχικής παρατήρησης**:
   ```python
   observation = env.reset()
   ```

3. **Βρόχος αλληλεπίδρασης**:
   ```python
   done = False
   total_reward = 0
   
   while not done:
       # Επιλογή ενέργειας (π.χ. από έναν πράκτορα RL)
       action = agent.select_action(observation)
       
       # Εκτέλεση ενέργειας
       next_observation, reward, done, info = env.step(action)
       
       # Ενημέρωση της συνολικής ανταμοιβής
       total_reward += reward
       
       # Απεικόνιση (προαιρετικά)
       env.render(mode='human')
       
       # Ενημέρωση της παρατήρησης
       observation = next_observation
   
   # Το επεισόδιο τελείωσε - εμφάνιση των τελικών μετρήσεων
   print(f"Τελική ανταμοιβή: {total_reward}")
   print(f"Μετρήσεις: {info['metrics']}")
   ```

## Μηχανισμός Ανταμοιβής

Ο μηχανισμός ανταμοιβής του περιβάλλοντος έχει σχεδιαστεί για να ενθαρρύνει τον πράκτορα να:

1. **Εντοπίζει αποδοτικές περιοχές ενδιαφέροντος**:
   * Ανταμοιβή για ROIs που επιτυγχάνουν καλύτερα αποτελέσματα ανίχνευσης από το σύνολο της εικόνας.
   * Ποινή για ROIs που δεν βελτιώνουν την απόδοση.

2. **Χρησιμοποιεί το χώρο αποδοτικά**:
   * Υψηλότερη ανταμοιβή όταν επιτυγχάνει παρόμοια ή καλύτερα αποτελέσματα με μικρότερη κάλυψη.
   * Η αποδοτικότητα υπολογίζεται ως συνάρτηση της βελτίωσης των μετρήσεων και του ποσοστού κάλυψης.

3. **Αποφεύγει την περιττή επικάλυψη**:
   * Ποινή για την τοποθέτηση bounding boxes με σημαντική επικάλυψη (IoU > 0.3).
   * Ενθάρρυνση για την τοποθέτηση διακριτών και συμπληρωματικών ROIs.

4. **Χρησιμοποιεί τον ελάχιστο αριθμό ROIs**:
   * Ποινή για υπερβολικό αριθμό ROIs (πάνω από 5).
   * Ενθάρρυνση για την επιλογή μόνο των πιο σημαντικών περιοχών.

### Επιμέρους Ανταμοιβές

* **Τοποθέτηση BBox**: 0 για επιτυχή τοποθέτηση, -1 για επικάλυψη > 30%.
* **Αφαίρεση BBox**: 0 αν υπάρχει BBox προς αφαίρεση, -0.1 αν η λίστα είναι κενή.
* **Τελική Ανταμοιβή**: Συνδυασμός των:
  * Διαφορά στην ακρίβεια (precision): `roi_precision - full_precision`
  * Διαφορά στην ανάκληση (recall): `roi_recall - full_recall`
  * Διαφορά στο mAP50: `roi_map50 - full_map50`
  * Συντελεστής αποδοτικότητας: `(1.0 - coverage_ratio) * 2`
  * Ποινή για υπερβολικά ROIs: `-0.2 * max(0, len(self.bboxes) - 5)`

## Μετρήσεις Αξιολόγησης

Το περιβάλλον παρέχει λεπτομερείς μετρήσεις για την αξιολόγηση της απόδοσης των επιλεγμένων ROIs:

* **Precision**: Το ποσοστό των προβλέψεων που είναι σωστές.
* **Recall**: Το ποσοστό των πραγματικών αντικειμένων που ανιχνεύθηκαν.
* **mAP50**: Το mean Average Precision με IoU threshold 0.5.
* **Κάλυψη**: Το ποσοστό της εικόνας που καλύπτεται από τα επιλεγμένα ROIs.
* **Αριθμός ROIs**: Ο αριθμός των ROIs που τοποθετήθηκαν.

## Συμβουλές Χρήσης

1. **Προεπεξεργασία Δεδομένων**:
   * Χρησιμοποιήστε ένα dataset με ποικιλία εικόνων και σωστά επισημασμένες περιοχές.
   * Βεβαιωθείτε ότι οι εικόνες είναι προεπεξεργασμένες σύμφωνα με τις απαιτήσεις του YOLO.

2. **Παράμετροι για Βελτιστοποίηση**:
   * Προσαρμόστε το μέγεθος των bounding boxes ανάλογα με τα αντικείμενα-στόχους.
   * Πειραματιστείτε με διαφορετικά κατώφλια IoU για την αποφυγή επικάλυψης.
   * Ρυθμίστε τα βάρη των διαφορετικών συστατικών της ανταμοιβής.

3. **Εκπαίδευση του Πράκτορα**:
   * Χρησιμοποιήστε αλγόριθμους RL που διαχειρίζονται αποτελεσματικά διακριτές ενέργειες, όπως DQN ή PPO.
   * Εφαρμόστε τεχνικές εξερεύνησης για να αποφύγετε τοπικά βέλτιστα.
   * Σχεδιάστε μια αρχιτεκτονική δικτύου που να μπορεί να επεξεργαστεί αποτελεσματικά οπτικά δεδομένα.

## Περιορισμοί και Μελλοντικές Βελτιώσεις

1. **Περιορισμοί**:
   * Το τρέχον περιβάλλον υποστηρίζει μόνο ορθογώνια bounding boxes.
   * Η αξιολόγηση βασίζεται στις μετρήσεις που παρέχονται από το YOLO.
   * Η προσαρμογή του μεγέθους των bounding boxes δεν υποστηρίζεται δυναμικά.

2. **Πιθανές Βελτιώσεις**:
   * Προσθήκη δυνατότητας για μη ορθογώνια/περιστρεφόμενα bounding boxes.
   * Υποστήριξη για δυναμική προσαρμογή του μεγέθους των bounding boxes.
   * Ενσωμάτωση πιο εξελιγμένων μεθόδων για την αξιολόγηση των ROIs.
   * Επέκταση της διεπαφής για υποστήριξη περισσότερων μοντέλων ανίχνευσης.

## Συμπεράσματα

Το περιβάλλον `ROIDetectionEnv` παρέχει ένα ολοκληρωμένο πλαίσιο για την εκπαίδευση πρακτόρων ενισχυτικής μάθησης στην αποτελεσματική ανίχνευση περιοχών ενδιαφέροντος σε εικόνες. Με τη χρήση του μοντέλου YOLO για την αξιολόγηση των ανιχνεύσεων, το περιβάλλον προσφέρει μια ρεαλιστική προσέγγιση στο πρόβλημα του εντοπισμού αντικειμένων.

Οι πράκτορες που εκπαιδεύονται σε αυτό το περιβάλλον μαθαίνουν να:
1. Επιλέγουν τις πιο σημαντικές περιοχές μιας εικόνας για ανίχνευση.
2. Ελαχιστοποιούν τον αριθμό και την κάλυψη των ROIs.
3. Βελτιστοποιούν την αποδοτικότητα της ανίχνευσης αντικειμένων.

Αυτή η προσέγγιση μπορεί να οδηγήσει σε πιο αποδοτικά συστήματα ανίχνευσης αντικειμένων, ιδιαίτερα σε περιπτώσεις όπου οι υπολογιστικοί πόροι είναι περιορισμένοι ή όταν η επεξεργασία ολόκληρων εικόνων υψηλής ανάλυσης είναι απαγορευτικά δαπανηρή.
